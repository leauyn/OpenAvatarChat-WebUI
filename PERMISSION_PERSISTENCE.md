# 权限持久化功能说明

## 概述

本功能实现了类似移动App的权限持久化效果，用户授权摄像头和麦克风权限后，下次启动应用时无需再次授权。

## 功能特性

### 1. 权限状态管理
- **自动检测权限状态**：应用启动时自动检查摄像头和麦克风权限
- **权限状态缓存**：将权限状态保存到localStorage，避免重复请求
- **权限状态验证**：检查权限状态的有效性（域名、用户代理、时间等）

### 2. 智能权限提示
- **条件显示**：只在权限未授权时显示权限提示界面
- **加载状态**：权限检查过程中显示加载提示
- **自动获取**：权限已授权时自动获取设备，无需用户操作

### 3. 权限状态监听
- **实时监听**：监听权限状态变化
- **自动恢复**：权限重新授予时自动恢复设备访问
- **页面焦点监听**：页面重新获得焦点时检查权限状态

## 技术实现

### 核心文件

1. **`src/utils/permissionManager.ts`** - 权限管理器
   - 权限状态检测和存储
   - 权限状态验证和过期处理
   - 权限状态更新和清除

2. **`src/utils/permissionListener.ts`** - 权限监听器
   - 权限变化监听
   - 页面可见性和焦点监听
   - 权限状态自动恢复

3. **`src/store/index.ts`** - Store集成
   - 权限检查方法
   - 权限监听器设置
   - 权限状态管理

4. **`src/components/WebcamPermission.vue`** - 权限提示组件
   - 智能显示逻辑
   - 加载状态处理
   - 用户交互处理

### 权限状态存储

权限状态存储在localStorage中，包含以下信息：
```typescript
interface PermissionState {
  camera: boolean           // 摄像头权限状态
  microphone: boolean       // 麦克风权限状态
  lastChecked: number       // 最后检查时间戳
  userAgent: string         // 用户代理信息
  domain: string           // 域名信息
}
```

### 权限状态验证

权限状态会在以下情况下失效：
- 超过30天未检查
- 域名发生变化
- 用户代理发生重大变化

## 使用流程

### 首次使用
1. 用户访问应用
2. 系统检查权限状态（无缓存）
3. 显示权限提示界面
4. 用户点击授权
5. 系统请求权限并保存状态
6. 进入视频聊天界面

### 再次使用
1. 用户访问应用
2. 系统检查权限状态（有缓存）
3. 验证权限状态有效性
4. 如果有效且已授权，直接进入视频聊天界面
5. 如果无效或未授权，显示权限提示界面

### 权限变化处理
1. 系统监听权限状态变化
2. 检测到权限被拒绝时，清除缓存状态
3. 检测到权限重新授予时，自动恢复设备访问

## 配置选项

### 权限有效期
```typescript
const PERMISSION_EXPIRY_DAYS = 30 // 权限状态有效期（天）
```

### 权限检查间隔
```typescript
this.checkInterval = window.setInterval(() => {
  this.checkPermissions()
}, 5000) // 每5秒检查一次
```

## 浏览器兼容性

- 支持所有现代浏览器
- 需要HTTPS环境（localhost除外）
- 需要支持getUserMedia API

## 注意事项

1. **HTTPS要求**：生产环境必须使用HTTPS协议
2. **权限策略**：遵循浏览器的权限策略
3. **隐私保护**：权限状态仅存储在本地，不会上传到服务器
4. **性能优化**：权限检查采用异步方式，不会阻塞UI

## 调试信息

系统会输出详细的调试信息，包括：
- 权限检查过程
- 权限状态变化
- 权限监听器状态
- 错误信息

可以通过浏览器控制台查看这些信息。

## 故障排除

### 权限检查失败
- 检查是否在HTTPS环境
- 检查浏览器是否支持getUserMedia
- 检查控制台错误信息

### 权限状态不持久
- 检查localStorage是否可用
- 检查域名是否发生变化
- 检查权限状态是否过期

### 权限监听不工作
- 检查页面是否获得焦点
- 检查权限监听器是否正确设置
- 检查控制台错误信息








